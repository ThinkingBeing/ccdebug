# 选择日志功能优化 - 设计文档

## 1. 需求概述

### 1.1 问题背景
1. 日志目录可能同时出现多个会话的日志，仅凭日志文件名（UUID格式）很难区分是哪个会话
2. 一个会话的日志可能有多个文件（主日志 + 子agent日志），目前下拉框直接显示文件名，很难快速识别子Agent

### 1.2 解决方案概述
1. 增加主日志选择对话框，显示会话元数据（时间、输入消息预览）
2. 子agent日志显示实际的agent名称，而非文件名

## 2. 详细设计

### 2.1 数据结构设计

#### 2.1.1 主日志摘要信息
```typescript
// web/src/types/index.ts
export interface MainLogSummary {
  /** 文件ID（不含.jsonl后缀的sessionId） */
  id: string;
  /** 文件名 */
  name: string;
  /** 文件完整路径 */
  path: string;
  /** 会话开始时间（第一条日志的timestamp） */
  startTime: string;
  /** 会话结束时间（最后一条日志的timestamp） */
  endTime: string;
  /** 会话输入消息预览（第一条user消息内容，截取前50字符） */
  inputPreview: string;
  /** 会话输入消息完整内容 */
  inputFull: string;
  /** 关联的子agent日志列表 */
  agentLogs: AgentLogInfo[];
}

export interface AgentLogInfo {
  /** 文件ID（agent-{agentId}） */
  id: string;
  /** 文件名 */
  name: string;
  /** 文件路径 */
  path: string;
  /** Agent ID */
  agentId: string;
  /** Agent名称（subagent_type） */
  agentName: string;
  /** Agent描述（subagent description） */
  agentDescription: string;
}
```

#### 2.1.2 文件列表响应扩展
```typescript
// 扩展现有的 FilesApiResponse
export interface FilesApiResponse {
  files: LogFileInfo[];
  latest: string | null;
  projectDir: string;
  logDir: string;
  sessionId: string | null;
  // 新增字段
  mainLogs?: MainLogSummary[];
}
```

### 2.2 后端API设计

#### 2.2.1 获取主日志列表 API
**端点**: `GET /api/main-logs`

**响应**:
```typescript
{
  success: boolean;
  mainLogs: MainLogSummary[];
  logDir: string;
}
```

**实现逻辑**:
1. 遍历日志目录，筛选主日志文件（非 `agent-*.jsonl` 格式的文件）
2. 对每个主日志文件：
   - 读取第一行获取 `startTime`
   - 读取最后一行获取 `endTime`
   - 遍历找到第一条 `message.role === 'user'` 的日志，提取消息内容作为预览
3. 查找关联的子agent日志
4. 按 `startTime` 降序排序

#### 2.2.2 获取指定主日志的文件列表 API
**端点**: `GET /api/files?mainLogId={id}`

**响应**: 返回主日志及其关联子agent日志的 `LogFileInfo[]`

**实现逻辑**:
1. 根据 `mainLogId` 读取主日志的 `sessionId`
2. 查找所有 `agent-*.jsonl` 文件
3. 读取每个子agent日志的第一行，检查其 `sessionId` 是否匹配
4. 匹配的文件加入返回列表
5. 对子agent日志解析其 `agentName`

### 2.3 子Agent名称解析逻辑

#### 2.3.1 解析步骤
```
子agent日志文件名: agent-{agentId}.jsonl
     ↓
步骤1: 提取 agentId（去除 "agent-" 前缀和 ".jsonl" 后缀）
     ↓
步骤2: 读取子agent日志第一行，获取 sessionId
     ↓
步骤3: 在主日志（{sessionId}.jsonl）中搜索包含 agentId 的 tool_result 日志
     ↓
步骤4: 从 tool_result 中获取 tool_use_id
     ↓
步骤5: 在主日志中搜索 id === tool_use_id 的 tool_use 日志
     ↓
步骤6: 从 tool_use.input 中提取 subagent_type 作为 agentName
```

#### 2.3.2 实现伪代码
```typescript
async function resolveAgentName(agentLogPath: string, mainLogPath: string): Promise<{name: string, description: string}> {
  // 1. 从文件名提取 agentId
  const fileName = path.basename(agentLogPath, '.jsonl');
  const agentId = fileName.replace('agent-', '');

  // 2. 读取主日志所有行
  const mainLogLines = fs.readFileSync(mainLogPath, 'utf-8').split('\n').filter(Boolean);

  // 3. 在主日志中查找包含 agentId 的 tool_result
  for (const line of mainLogLines) {
    const entry = JSON.parse(line);
    const content = entry.message?.content;
    if (!Array.isArray(content)) continue;

    for (const block of content) {
      // 查找 tool_result，其 content 包含 agentId
      if (block.type === 'tool_result' &&
          typeof block.content === 'string' &&
          block.content.includes(agentId)) {
        const toolUseId = block.tool_use_id;

        // 4. 查找对应的 tool_use
        const toolUse = findToolUseById(mainLogLines, toolUseId);
        if (toolUse && toolUse.input?.subagent_type) {
          return {
            name: toolUse.input.subagent_type,
            description: toolUse.input.description || ''
          };
        }
      }
    }
  }

  // 回退：返回 agentId
  return { name: agentId, description: '' };
}
```

### 2.4 前端组件设计

#### 2.4.1 主日志选择对话框组件
**文件**: `web/src/components/MainLogSelectDialog.vue`

**功能**:
- 显示主日志列表表格
- 列包含：文件名、开始时间、结束时间、输入消息预览
- 单选操作
- 确定/取消按钮

**UI设计**:
```
┌─────────────────────────────────────────────────────────────────────┐
│  选择会话日志                                                    [X] │
├─────────────────────────────────────────────────────────────────────┤
│ ┌─────────────────────────────────────────────────────────────────┐ │
│ │ 文件名                    │ 开始时间  │ 结束时间  │ 输入消息    │ │
│ ├─────────────────────────────────────────────────────────────────┤ │
│ │○ 31a609a6-383f-48b3...   │ 11/11 16:46│ 11/11 17:23│ 帮我分析...│ │
│ │● 5e33bb74-2a1c-4d9e...   │ 11/10 14:20│ 11/10 15:01│ 请编写...  │ │
│ │○ 9ac5013a-8b7f-4e2a...   │ 11/09 09:15│ 11/09 09:45│ 修复bug... │ │
│ └─────────────────────────────────────────────────────────────────┘ │
│                                                                     │
│                                          [取消]  [确定]             │
└─────────────────────────────────────────────────────────────────────┘
```

**组件Props**:
```typescript
interface Props {
  visible: boolean;
  mainLogs: MainLogSummary[];
  loading: boolean;
}
```

**组件Events**:
```typescript
interface Emits {
  (e: 'update:visible', value: boolean): void;
  (e: 'select', mainLog: MainLogSummary): void;
}
```

#### 2.4.2 ProjectPanel 组件修改
**文件**: `web/src/components/ProjectPanel.vue`

**修改点**:
1. 在日志文件下拉框旁增加"选择会话"按钮
2. 点击按钮打开 `MainLogSelectDialog`
3. 选择确定后，更新下拉框选项为选中的主日志及其子agent日志
4. 子agent日志选项显示 `agentName` 而非文件名

**UI变更**:
```
修改前:
┌─────────────────────────────────┐
│ 日志文件: [下拉框▼]             │
└─────────────────────────────────┘

修改后:
┌─────────────────────────────────────────┐
│ 日志文件: [下拉框▼] [选择会话]          │
└─────────────────────────────────────────┘
```

**下拉框选项显示逻辑**:
```
主日志:    显示文件名（如：31a609a6-383f-48b3-9271-17d6563bd132）
子agent:   显示 agentName（如：需求分析Agent、列表控件Agent）
```

### 2.5 状态管理修改

**文件**: `web/src/stores/timeline.ts`

**新增状态**:
```typescript
const mainLogs = ref<MainLogSummary[]>([]);          // 主日志列表
const selectedMainLog = ref<MainLogSummary | null>(null); // 当前选中的主日志
const mainLogsLoading = ref(false);                  // 加载状态
```

**新增Actions**:
```typescript
// 获取主日志列表
async function fetchMainLogs(): Promise<void>;

// 选择主日志，刷新文件列表
async function selectMainLog(mainLog: MainLogSummary): Promise<void>;
```

**修改initialize逻辑**:
```typescript
async function initialize() {
  // 1. 获取主日志列表
  await fetchMainLogs();

  // 2. 默认选中第一个主日志
  if (mainLogs.value.length > 0) {
    await selectMainLog(mainLogs.value[0]);
  }
}
```

## 3. 实现计划

### 3.1 后端实现

| 任务 | 文件 | 说明 |
|------|------|------|
| 1 | `web/server/log-file-manager.ts` | 新增 `getMainLogSummaries()` 方法 |
| 2 | `web/server/log-file-manager.ts` | 新增 `resolveAgentName()` 方法 |
| 3 | `web/server/log-file-manager.ts` | 新增 `getAgentLogsForSession()` 方法 |
| 4 | `web/server/web-server.ts` | 新增 `GET /api/main-logs` 路由 |
| 5 | `web/server/web-server.ts` | 修改 `GET /api/files` 支持 `mainLogId` 参数 |

### 3.2 前端实现

| 任务 | 文件 | 说明 |
|------|------|------|
| 1 | `web/src/types/index.ts` | 新增 `MainLogSummary`、`AgentLogInfo` 类型 |
| 2 | `web/src/components/MainLogSelectDialog.vue` | 新增主日志选择对话框组件 |
| 3 | `web/src/components/ProjectPanel.vue` | 添加"选择会话"按钮，集成对话框 |
| 4 | `web/src/stores/timeline.ts` | 新增主日志相关状态和方法 |
| 5 | `web/src/components/ProjectPanel.vue` | 修改下拉框显示逻辑（子agent显示名称） |

### 3.3 实现顺序

```
Phase 1: 后端基础能力
  1.1 实现 getMainLogSummaries()
  1.2 实现 resolveAgentName()
  1.3 新增 /api/main-logs 接口

Phase 2: 前端类型和Store
  2.1 添加类型定义
  2.2 扩展 timeline store

Phase 3: 前端组件
  3.1 实现 MainLogSelectDialog 组件
  3.2 修改 ProjectPanel 组件
  3.3 调整下拉框显示逻辑

Phase 4: 集成测试
  4.1 测试主日志选择流程
  4.2 测试子agent名称解析
  4.3 测试初始化默认选中逻辑
```

## 4. 技术细节

### 4.1 日志文件格式说明

**主日志命名**: `{sessionId}.jsonl` (UUID格式)
**子agent日志命名**: `agent-{agentId}.jsonl`

**日志条目关键字段**:
```json
{
  "type": "user" | "assistant",
  "timestamp": "2025-11-11T08:46:08.276Z",
  "sessionId": "31a609a6-383f-48b3-9271-17d6563bd132",
  "message": {
    "role": "user" | "assistant",
    "content": "..." | [{ "type": "text", "text": "..." }]
  }
}
```

**tool_use 结构**:
```json
{
  "type": "tool_use",
  "id": "toolu_01J4NHnbBhYM6jZ6uYT4yjTu",
  "name": "Task",
  "input": {
    "subagent_type": "需求分析Agent",
    "description": "分析需求",
    "prompt": "..."
  }
}
```

### 4.2 时间格式处理

- 日志中的时间为 ISO 8601 格式（UTC）
- 前端显示需转换为中国时区（UTC+8）
- 显示格式建议：`MM/DD HH:mm` 或 `YYYY-MM-DD HH:mm:ss`

```typescript
function formatTimeToCST(isoString: string): string {
  const date = new Date(isoString);
  return date.toLocaleString('zh-CN', {
    timeZone: 'Asia/Shanghai',
    month: '2-digit',
    day: '2-digit',
    hour: '2-digit',
    minute: '2-digit'
  });
}
```

### 4.3 消息预览提取

```typescript
function extractInputPreview(logLines: string[]): { preview: string; full: string } {
  for (const line of logLines) {
    const entry = JSON.parse(line);
    if (entry.message?.role === 'user') {
      const content = entry.message.content;
      let fullText = '';

      if (typeof content === 'string') {
        fullText = content;
      } else if (Array.isArray(content) && content.length > 0) {
        const firstBlock = content[0];
        if (firstBlock.type === 'text') {
          fullText = firstBlock.text;
        } else if (typeof firstBlock === 'string') {
          fullText = firstBlock;
        }
      }

      return {
        preview: fullText.slice(0, 20) + (fullText.length > 20 ? '...' : ''),
        full: fullText
      };
    }
  }
  return { preview: '', full: '' };
}
```

## 5. 界面交互流程

```
用户打开页面
    ↓
自动加载主日志列表
    ↓
默认选中第一个主日志
    ↓
下拉框显示主日志及其子agent日志
    ↓
用户可点击"选择会话"按钮
    ↓
弹出主日志选择对话框
    ↓
显示所有主日志（含时��、预览信息）
    ↓
用户选择一个主日志并确定
    ↓
下拉框刷新为选中主日志及其子agent
    ↓
自动加载选中的主日志内容
```

## 6. 风险与注意事项

1. **性能考虑**: 主日志列表需要读取每个文件的首尾行，文件数量多时可能影响性能
   - 建议: 实现缓存机制，或限制扫描文件数量

2. **子agent名称解析**: 需要在主日志中搜索，可能存在匹配不到的情况
   - 建议: 解析失败时回退显示 agentId

3. **大文件处理**: 某些日志文件可能很大
   - 建议: 使用流式读取，只读取必要的行

4. **并发问题**: 日志文件可能正在被写入
   - 建议: 添加适当的错误处理

## 7. 附录

### 7.1 相关文件清单

- `web/server/log-file-manager.ts` - 日志文件管理
- `web/server/web-server.ts` - Web服务器路由
- `web/server/conversation-parser.ts` - 对话解析器
- `web/src/components/ProjectPanel.vue` - 项目面板组件
- `web/src/stores/timeline.ts` - 时间线状态管理
- `web/src/types/index.ts` - 类型定义

### 7.2 示例日志目录结构

```
.claude-trace/cclog/
├── 31a609a6-383f-48b3-9271-17d6563bd132.jsonl  # 主日志
├── agent-5e33bb74.jsonl                         # 子agent: 需求分析Agent
├── agent-95c58af2.jsonl                         # 子agent: 列表控件Agent
├── agent-9ac5013a.jsonl                         # 子agent: 页面开发Agent
├── 另一个sessionId.jsonl                        # 另一个会话的主日志
└── agent-xxx.jsonl                              # 另一个会话的子agent
```
