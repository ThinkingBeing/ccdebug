# 项目切换功能设计文档

## 需求概述

当以web站点形式启动工具时（使用`--serve`、`--log`或`-l`参数），需要实现项目切换功能：

1. 在页面左侧面板的"项目信息"同一行，增加"选择项目"按钮
2. 点击按钮弹出对话框，显示当前用户主目录的`.claude/projects`下的所有子目录列表
3. 列表单选，选择并确定后，关闭对话框，当前项目切换到选择的项目目录
4. 默认选中ccdebug命令运行的当前目录，如果用户运行命令时指定了`--project`参数，则默认选择此目录

## 设计原则

- 实现方案尽量简洁
- 兼容Windows、macOS、Linux等不同操作系统
- 复用现有的对话框组件模式（参考MainLogSelectDialog.vue）
- 最小化代码改动，保持架构一致性

## 技术方案

### 1. 前端实现

#### 1.1 新增组件：ProjectSelectDialog.vue

参考`MainLogSelectDialog.vue`的实现，创建项目选择对话框组件：

**位置**：`web/src/components/ProjectSelectDialog.vue`

**主要功能**：
- 显示可用项目列表（来自`~/.claude/projects`目录）
- 支持单选
- 显示当前选中的项目（高亮显示）
- 提供确认和取消按钮

**组件接口**：
```typescript
interface Props {
  visible: boolean;           // 对话框显示状态
  projects: ProjectInfo[];    // 可用项目列表
  currentProject: string;     // 当前项目路径
  loading: boolean;           // 加载状态
}

interface Emits {
  'update:visible': (visible: boolean) => void;
  'select': (projectPath: string) => void;
}

interface ProjectInfo {
  path: string;              // 项目完整路径
  name: string;              // 项目名称（目录名）
  isDefault: boolean;        // 是否为启动时的默认项目
}
```

#### 1.2 修改组件：ProjectPanel.vue

在"项目信息"卡片的标题行增加"选择项目"按钮：

**修改位置**：`web/src/components/ProjectPanel.vue`第3行

**变更内容**：
```vue
<a-card title="项目信息" :bordered="false" size="small" class="file-card">
  <template #extra>
    <a-button type="primary" size="small" @click="showProjectDialog" :loading="projectsLoading">
      选择项目
    </a-button>
  </template>
  <!-- 原有的项目信息显示 -->
</a-card>

<!-- 新增：项目选择对话框 -->
<ProjectSelectDialog
  v-model:visible="projectDialogVisible"
  :projects="availableProjects"
  :current-project="currentProject?.path"
  :loading="projectsLoading"
  @select="handleProjectSelect"
/>
```

**新增状态和方法**：
```typescript
// 状态
const projectDialogVisible = ref(false);
const availableProjects = ref<ProjectInfo[]>([]);
const projectsLoading = ref(false);

// 方法
const showProjectDialog = async () => {
  projectsLoading.value = true;
  try {
    // 调用API获取可用项目列表
    availableProjects.value = await timelineStore.fetchAvailableProjects();
  } finally {
    projectsLoading.value = false;
  }
  projectDialogVisible.value = true;
};

const handleProjectSelect = async (projectPath: string) => {
  await timelineStore.switchProject(projectPath);
  projectDialogVisible.value = false;
};
```

#### 1.3 修改Store：timeline.ts

在`web/src/stores/timeline.ts`中新增两个action：

```typescript
// 获取可用项目列表
async fetchAvailableProjects(): Promise<ProjectInfo[]> {
  try {
    const response = await fetch('/api/projects');
    const result = await response.json();
    if (result.success) {
      return result.data.projects;
    }
    throw new Error(result.error || '获取项目列表失败');
  } catch (error) {
    console.error('获取项目列表失败:', error);
    throw error;
  }
}

// 切换项目
async switchProject(projectPath: string): Promise<void> {
  try {
    const response = await fetch('/api/project/switch', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ projectPath })
    });
    const result = await response.json();
    if (result.success) {
      // 切换成功后重新初始化
      await this.initialize();
    } else {
      throw new Error(result.error || '切换项目失败');
    }
  } catch (error) {
    console.error('切换项目失败:', error);
    throw error;
  }
}
```

### 2. 后端实现

#### 2.1 新增API：GET /api/projects

获取用户主目录下`.claude/projects`的所有子目录列表。

**位置**：`web/server/web-server.ts`的`setupRoutes()`方法中

**实现代码**：
```typescript
// 获取可用项目列表API
this.app.get('/api/projects', async (req, res) => {
  try {
    const os = require('os');
    const projectsDir = path.join(os.homedir(), '.claude', 'projects');

    // 检查目录是否存在
    if (!fs.existsSync(projectsDir)) {
      return res.json({
        success: true,
        data: {
          projects: [],
          defaultProject: this.config.projectDir
        }
      });
    }

    // 读取所有子目录
    const entries = fs.readdirSync(projectsDir, { withFileTypes: true });
    const projects = entries
      .filter(entry => entry.isDirectory())
      .map(entry => {
        const projectPath = path.join(projectsDir, entry.name);
        return {
          path: projectPath,
          name: entry.name,
          isDefault: path.resolve(projectPath) === path.resolve(this.config.projectDir)
        };
      })
      .sort((a, b) => {
        // 默认项目排在最前面
        if (a.isDefault) return -1;
        if (b.isDefault) return 1;
        return a.name.localeCompare(b.name);
      });

    const response: any = {
      success: true,
      data: {
        projects: projects,
        defaultProject: this.config.projectDir,
        projectsDir: projectsDir
      }
    };

    res.json(response);
  } catch (error) {
    console.error('获取项目列表失败:', error);
    const response: any = {
      success: false,
      error: error instanceof Error ? error.message : '未知错误'
    };
    res.status(500).json(response);
  }
});
```

#### 2.2 新增API：POST /api/project/switch

切换当前项目目录，并重新初始化相关服务。

**位置**：`web/server/web-server.ts`的`setupRoutes()`方法中

**实现代码**：
```typescript
// 切换项目API
this.app.post('/api/project/switch', async (req, res) => {
  try {
    const { projectPath } = req.body;

    if (!projectPath) {
      return res.status(400).json({
        success: false,
        error: '缺少projectPath参数'
      });
    }

    // 验证项目路径是否存在
    if (!fs.existsSync(projectPath)) {
      return res.status(400).json({
        success: false,
        error: `项目路径不存在: ${projectPath}`
      });
    }

    // 更新配置
    this.config.projectDir = path.resolve(projectPath);

    // 重新确定日志目录
    this.logDir = path.join(this.config.projectDir, '.claude-trace/cclog');

    let useDefaultLogDir = true;
    if (fs.existsSync(this.logDir)) {
      try {
        const files = fs.readdirSync(this.logDir);
        const hasJsonlFiles = files.some(file => file.endsWith('.jsonl'));
        if (hasJsonlFiles) {
          useDefaultLogDir = false;
          dlog(`使用默认日志目录: ${this.logDir}`);
        }
      } catch (error) {
        console.error('读取日志目录失败:', error);
      }
    }

    if (useDefaultLogDir) {
      this.logDir = this.logFileManager.resolveLogDirectory(this.config.projectDir);
      dlog(`使用备用日志目录: ${this.logDir}`);
    }

    // 更新ConversationParser的日志目录
    this.conversationParser.setLogDirectory(this.logDir);

    console.log(`项目已切换到: ${this.config.projectDir}`);
    console.log(`日志目录已更新为: ${this.logDir}`);

    const response: any = {
      success: true,
      data: {
        projectDir: this.config.projectDir,
        logDir: this.logDir
      }
    };

    res.json(response);
  } catch (error) {
    console.error('切换项目失败:', error);
    const response: any = {
      success: false,
      error: error instanceof Error ? error.message : '未知错误'
    };
    res.status(500).json(response);
  }
});
```

### 3. 类型定义

#### 3.1 新增类型

在`web/src/types/index.ts`中新增：

```typescript
// 项目信息接口（扩展）
export interface AvailableProjectInfo {
  path: string;         // 项目完整路径
  name: string;         // 项目名称（目录名）
  isDefault: boolean;   // 是否为启动时的默认项目
}

// 项目列表API响应
export interface ProjectsApiResponse {
  projects: AvailableProjectInfo[];
  defaultProject: string;
  projectsDir: string;
}
```

## 跨平台兼容性

### 路径处理

使用Node.js原生模块确保跨平台兼容：

```typescript
const os = require('os');
const path = require('path');

// 获取用户主目录（跨平台）
const homeDir = os.homedir();
// Windows: C:\Users\username
// macOS/Linux: /home/username 或 /Users/username

// 拼接路径（自动处理分隔符）
const projectsDir = path.join(homeDir, '.claude', 'projects');
// Windows: C:\Users\username\.claude\projects
// macOS/Linux: /home/username/.claude/projects

// 规范化路径（处理相对路径、..等）
const normalizedPath = path.resolve(projectPath);
```

### 文件系统操作

```typescript
// 检查目录是否存在
if (fs.existsSync(projectsDir)) {
  // 读取目录内容（跨平台）
  const entries = fs.readdirSync(projectsDir, { withFileTypes: true });

  // 过滤出目录
  const directories = entries.filter(entry => entry.isDirectory());
}
```

## 实现步骤

### 阶段1：后端API实现
1. 在`web/server/web-server.ts`中添加两个新API
2. 测试API功能是否正常

### 阶段2：前端组件实现
1. 创建`ProjectSelectDialog.vue`组件
2. 修改`ProjectPanel.vue`，添加"选择项目"按钮
3. 在`timeline.ts` store中添加相关action

### 阶段3：集成测试
1. 启动web服务器测试项目列表获取
2. ���试项目切换功能
3. 验证跨平台兼容性（Windows/Mac）

### 阶段4：用户体验优化
1. 添加加载状态提示
2. 添加错误处理和提示
3. 优化UI交互

## 边界情况处理

1. **`.claude/projects`目录不存在**：返回空列表，仅显示当前项目
2. **项目目录无日志文件**：切换后显示空状态提示
3. **项目路径无效**：显示错误提示，不执行切换
4. **切换失败**：保持当前项目，显示错误信息
5. **Windows路径特殊字符**：使用`path.resolve()`规范化路径

## 兼容性说明

- **Node.js版本**：要求Node.js 14+（已满足项目要求）
- **操作系统**：Windows 10+、macOS 10.15+、Linux（主流发行版）
- **浏览器**：Chrome 90+、Firefox 88+、Safari 14+、Edge 90+

## 测试计划

### 单元测试
- 测试API `/api/projects` 返回正确的项目列表
- 测试API `/api/project/switch` 能正确切换项目
- 测试路径处理函数的跨平台兼容性

### 集成测试
- 测试前端组件与后端API的交互
- 测试项目切换后日志文件列表的更新
- 测试默认项目的正确标记和显示

### 手动测试
- 在Windows环境下测试完整流程
- 在macOS环境下测试完整流程
- 测试异常情况的错误提示

## 代码估算

- 新增文件：1个（ProjectSelectDialog.vue）
- 修改文件：3个（ProjectPanel.vue、timeline.ts、web-server.ts）
- 新增代码：约200行
- 修改代码：约50行

## 风险评估

- **低风险**：使用成熟的Node.js原生API，无需引入新依赖
- **低风险**：复用现有组件模式，代码结构清晰
- **低风险**：不涉及数据持久化，切换失败不会影响数据
